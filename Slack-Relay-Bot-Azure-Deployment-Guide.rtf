{\rtf1\ansi\deff0
{\fonttbl\f0\fswiss Arial;\f1\fmodern Courier New;}
{\colortbl;\red40\green40\blue40;\red0\green102\blue204;\red180\green0\blue0;}
\paperw12240\paperh15840\margl1440\margr1440\margt1080\margb1080

\pard\qc\b\fs36 Slack Relay Bot – Azure App Service Deployment Guide\b0\par
\pard\qc Version 1.0  \bullet  Generated: October 8, 2025\par
\pard\par
\b Overview\b0\par
This document provides a comprehensive, production-conscious, step-by-step guide to deploy the Slack Relay Bot (Node.js + Express + Slack Bolt Socket Mode + Microsoft Copilot Studio integration) to Azure App Service. Two deployment models are covered: (A) Source (Zip/Build) Deployment and (B) Container Deployment (recommended).\par
\par
\b Table of Contents\b0\par
1. Application Runtime Profile\par
2. Prerequisites\par
3. Deployment Model Decision Matrix\par
4. Resource Group Creation\par
5. Option A: Source Deployment Steps\par
6. Option B: Container Deployment Steps\par
7. Azure Key Vault Integration (Secrets Hardening)\par
8. Microsoft Entra ID (Azure AD) Configuration\par
9. Slack App Configuration Checklist\par
10. BASE_URL Usage\par
11. CI/CD Automation (GitHub Actions)\par
12. Validation & Smoke Tests\par
13. Troubleshooting & Common Issues\par
14. Post-Deployment Hardening Recommendations\par
15. Quick Local Parity Test\par
16. Summary\par
\par
\b 1. Application Runtime Profile\b0\par
Entry Point: \f1 src/app.js\f0\par
Start Script: \f1 npm start\f0 (defined in package.json)\par
Port: Uses environment variable PORT (defaults to 8005).\par
External Endpoints: /health, /status, /auth/login/:slackUserId, /auth/callback\par
Authentication: Microsoft Entra ID OAuth 2.0 + PKCE, optional future SAML logic placeholders.\par
Slack Connection: Socket Mode (outbound WebSocket, no inbound public webhook required).\par
Core Dependencies: express, @slack/bolt, @microsoft/agents-copilotstudio-client, @azure/msal-node\par
\par
Required Environment Variables (baseline):\par
\pard\li720 COPILOT_ENVIRONMENT_ID\par
COPILOT_AGENT_IDENTIFIER\par
COPILOT_APP_CLIENT_ID\par
COPILOT_CLIENT_SECRET\par
COPILOT_TENANT_ID\par
SLACK_BOT_TOKEN\par
SLACK_SIGNING_SECRET\par
SLACK_APP_TOKEN\par
BASE_URL (set to public URL of the deployed app)\par
Optional / Recommended: LOG_LEVEL, NODE_ENV, WEBSITES_PORT (container), AUTH_POPUP_CLOSE_DELAY\par
\pard\par
\b 2. Prerequisites\b0\par
\pard\li720 Azure Subscription access with Contributor or higher on target RG.\par
Azure CLI installed and authenticated (\f1 az login\f0).\par
Slack App configured (Bot + Socket Mode).\par
Microsoft Entra ID App Registration (client id, tenant id, secret).\par
Docker (if using container path).\par
(Recommended) GitHub repository for CI/CD.\par
(Recommended) Azure Key Vault for secrets governance.\par
\pard\par
\b 3. Deployment Model Decision Matrix\b0\par
\pard\li720 A. Source (Zip) Deployment: Simple, fast, fewer moving parts.\par
B. Container Deployment: Reproducibility, parity with local Docker, tighter runtime control (preferred).\par
\pard\par
\b 4. Resource Group Creation\b0\par
PowerShell Example:\par
\f1 az group create --name rg-slack-relay-prod --location eastus\f0\par
\par
\b 5. Option A – Source (Zip) Deployment\b0\par
\pard\li720 1. Create Linux App Service Plan (Node 18):\par
\f1 az appservice plan create --name asp-slack-relay --resource-group rg-slack-relay-prod --sku B1 --is-linux\f0\par
2. Create Web App:\par
\f1 az webapp create --resource-group rg-slack-relay-prod --plan asp-slack-relay --name slack-relay-bot-app --runtime "NODE:18-lts"\f0\par
3. (Optional) Enable logging:\par
\f1 az webapp log config --name slack-relay-bot-app --resource-group rg-slack-relay-prod --application-logging true --level Information\f0\par
4. Configure App Settings (replace placeholders):\par
\f1 az webapp config appsettings set -g rg-slack-relay-prod -n slack-relay-bot-app --settings \par
  COPILOT_ENVIRONMENT_ID=... COPILOT_AGENT_IDENTIFIER=... COPILOT_APP_CLIENT_ID=... \par
  COPILOT_CLIENT_SECRET=... COPILOT_TENANT_ID=... SLACK_BOT_TOKEN=... \par
  SLACK_SIGNING_SECRET=... SLACK_APP_TOKEN=... BASE_URL=https://slack-relay-bot-app.azurewebsites.net \par
  LOG_LEVEL=info NODE_ENV=production\f0\par
5. Deploy Code (Oryx build / Zip Deploy):\par
\f1 az webapp deploy --resource-group rg-slack-relay-prod --name slack-relay-bot-app --src-path . --type zip\f0\par
6. Add Redirect URI in Entra ID: \f1 https://slack-relay-bot-app.azurewebsites.net/auth/callback\f0\par
7. Test Health Endpoint:\par
\f1 Invoke-RestMethod https://slack-relay-bot-app.azurewebsites.net/health\f0\par
\pard\par
\b 6. Option B – Container Deployment (Recommended)\b0\par
\pard\li720 1. Create ACR:\par
\f1 az acr create -g rg-slack-relay-prod -n acrslackrelay1234 --sku Basic --admin-enabled true\f0\par
2. Login & Build Image:\par
\f1 az acr login --name acrslackrelay1234\par
docker build -t acrslackrelay1234.azurecr.io/slack-relay-bot:1.0.0 .\par
docker push acrslackrelay1234.azurecr.io/slack-relay-bot:1.0.0\f0\par
3. Create Web App for Containers (reuse plan):\par
\f1 az webapp create --resource-group rg-slack-relay-prod --plan asp-slack-relay --name slack-relay-bot-cont --deployment-container-image-name acrslackrelay1234.azurecr.io/slack-relay-bot:1.0.0\f0\par
4. Configure Container Settings (if needed):\par
\f1 az webapp config container set -g rg-slack-relay-prod -n slack-relay-bot-cont --docker-custom-image-name acrslackrelay1234.azurecr.io/slack-relay-bot:1.0.0\f0\par
5. Set App Settings (note WEBSITES_PORT):\par
\f1 az webapp config appsettings set -g rg-slack-relay-prod -n slack-relay-bot-cont --settings COPILOT_ENVIRONMENT_ID=... COPILOT_AGENT_IDENTIFIER=... COPILOT_APP_CLIENT_ID=... COPILOT_CLIENT_SECRET=... COPILOT_TENANT_ID=... SLACK_BOT_TOKEN=... SLACK_SIGNING_SECRET=... SLACK_APP_TOKEN=... BASE_URL=https://slack-relay-bot-cont.azurewebsites.net LOG_LEVEL=info NODE_ENV=production WEBSITES_PORT=8005\f0\par
6. Update Image on New Versions:\par
\f1 docker build -t acrslackrelay1234.azurecr.io/slack-relay-bot:1.0.1 .\par
docker push acrslackrelay1234.azurecr.io/slack-relay-bot:1.0.1\par
az webapp config container set -g rg-slack-relay-prod -n slack-relay-bot-cont --docker-custom-image-name acrslackrelay1234.azurecr.io/slack-relay-bot:1.0.1\f0\par
\pard\par
\b 7. Azure Key Vault Integration\b0\par
\pard\li720 Create Key Vault:\par
\f1 az keyvault create -n kv-slack-relay -g rg-slack-relay-prod -l eastus\f0\par
Store Secrets:\par
\f1 az keyvault secret set -n COPILOT-CLIENT-SECRET --vault-name kv-slack-relay --value <secret>\f0\par
Assign Managed Identity & Policy:\par
\f1 az webapp identity assign -g rg-slack-relay-prod -n slack-relay-bot-cont\par
az keyvault set-policy -n kv-slack-relay -g rg-slack-relay-prod --object-id <principalId> --secret-permissions get list\f0\par
Reference Secret in App Setting:\par
\f1 COPILOT_CLIENT_SECRET=@Microsoft.KeyVault(SecretUri=https://kv-slack-relay.vault.azure.net/secrets/COPILOT-CLIENT-SECRET/)\f0\par
\pard\par
\b 8. Microsoft Entra ID Configuration\b0\par
\pard\li720 Add redirect URI matching deployed BASE_URL + /auth/callback.\par
Use Authorization Code Flow with PKCE (client secret only on server).\par
Scopes: Start with \f1 https://api.powerplatform.com/.default\f0 then refine to least privilege.\par
Rotate client secret regularly; store only in Key Vault.\par
\pard\par
\b 9. Slack App Configuration Checklist\b0\par
\pard\li720 Enable Socket Mode (App Token xapp-).\par
Obtain Bot Token (xoxb-), Signing Secret, App Token.\par
Add Bot Scopes (e.g. chat:write, app_mentions:read, im:history, commands).\par
Slash commands (e.g. /newchat) if implemented.\par
No public events endpoint required because of Socket Mode.\par
\pard\par
\b 10. BASE_URL Usage\b0\par
Must reflect public HTTPS endpoint. Affects OAuth redirect URL composition. Update on custom domain adoption.\par
\par
\b 11. CI/CD (GitHub Actions) – Summaries\b0\par
Source Deploy: Checkout → Node install → Zip → Use azure/webapps-deploy.\par
Container Deploy: Build Docker → Push to ACR → Update Web App container image.\par
Store AZURE_CREDENTIALS in GitHub Secrets.\par
\par
\b 12. Validation & Smoke Tests\b0\par
\pard\li720 Health: \f1 Invoke-RestMethod https://<app>.azurewebsites.net/health\f0\par
Status: \f1 Invoke-RestMethod https://<app>.azurewebsites.net/status\f0\par
Slack DM: Should request authentication if not authorized.\par
OAuth Flow: Complete Microsoft login → success page closes → Slack notified.\par
Logs Tail: \f1 az webapp log tail -g <rg> -n <app>\f0\par
\pard\par
\b 13. Troubleshooting & Common Issues\b0\par
\pard\li720 502 / Startup Fail: Missing WEBSITES_PORT or crash in startup logs.\par
Auth Error: Redirect URI mismatch → verify BASE_URL + Entra config.\par
No Slack Responses: Slack tokens absent or invalid.\par
Socket Disconnects: Enable Always On; consider higher SKU.\par
\pard\par
\b 14. Post-Deployment Hardening\b0\par
\pard\li720 Enforce HTTPS only: \f1 az webapp update --https-only true\f0\par
Add Front Door / WAF for advanced protection.\par
Implement rate limiting (e.g., API Management in front).\par
Reduce scopes from .default to explicit minimal scopes.\par
Add monitoring (App Insights + Log Analytics).\par
Audit logs for auth events.\par
\pard\par
\b 15. Quick Local Parity (Container)\b0\par
\f1 docker build -t slack-relay-bot:local .\par
docker run --rm -p 8005:8005 -e COPILOT_ENVIRONMENT_ID=... -e COPILOT_AGENT_IDENTIFIER=... -e COPILOT_APP_CLIENT_ID=... -e COPILOT_CLIENT_SECRET=... -e COPILOT_TENANT_ID=... -e SLACK_BOT_TOKEN=... -e SLACK_SIGNING_SECRET=... -e SLACK_APP_TOKEN=... -e BASE_URL=http://localhost:8005 slack-relay-bot:local\f0\par
\par
\b 16. Summary\b0\par
Container deployment offers reproducibility and aligns with existing Dockerfile. Key production steps: secure secrets (Key Vault + Managed Identity), enforce HTTPS, refine scopes, monitor health, automate builds.\par
\par
\b Appendix A: Environment Variable Reference\b0\par
\pard\li720 COPILOT_*: Microsoft Copilot Studio connectivity.\par
SLACK_*: Slack Socket Mode + Bot integration.\par
BASE_URL: Forms OAuth redirect.\par
WEBSITES_PORT: Required for custom container on App Service.\par
LOG_LEVEL / NODE_ENV: Observability + behavior adjustments.\par
\pard\par
\b Appendix B: Recommended Next Enhancements\b0\par
\pard\li720 Add Infrastructure as Code (Bicep/Terraform).\par
Introduce structured logging + correlation IDs.\par
Implement rate limiting / abuse detection.\par
Add automated secret rotation pipeline.\par
Add integration tests hitting /health and mock Slack events.\par
\pard\par
\pard\qc\b End of Document\b0\par
}
